(* let input = *)
(*   ".......S.......\n\ *)
(*    ...............\n\ *)
(*    .......^.......\n\ *)
(*    ...............\n\ *)
(*    ......^.^......\n\ *)
(*    ...............\n\ *)
(*    .....^.^.^.....\n\ *)
(*    ...............\n\ *)
(*    ....^.^...^....\n\ *)
(*    ...............\n\ *)
(*    ...^.^...^.^...\n\ *)
(*    ...............\n\ *)
(*    ..^...^.....^..\n\ *)
(*    ...............\n\ *)
(*    .^.^.^.^.^...^.\n\ *)
(*    ..............." *)

let input =
  "......................................................................S......................................................................\n\
   .............................................................................................................................................\n\
   ......................................................................^......................................................................\n\
   .............................................................................................................................................\n\
   .....................................................................^.^.....................................................................\n\
   .............................................................................................................................................\n\
   ....................................................................^.^.^....................................................................\n\
   .............................................................................................................................................\n\
   ...................................................................^.^...^...................................................................\n\
   .............................................................................................................................................\n\
   ..................................................................^...^...^..................................................................\n\
   .............................................................................................................................................\n\
   .................................................................^...^.^.^.^.................................................................\n\
   .............................................................................................................................................\n\
   ................................................................^.^...^.^.^.^................................................................\n\
   .............................................................................................................................................\n\
   ...............................................................^.^.^.^.^.^...^...............................................................\n\
   .............................................................................................................................................\n\
   ..............................................................^.^...^.^.^.....^..............................................................\n\
   .............................................................................................................................................\n\
   .............................................................^.^.^.....^...^.^.^.............................................................\n\
   .............................................................................................................................................\n\
   ............................................................^.^.^.^...^.^.^.^...^............................................................\n\
   .............................................................................................................................................\n\
   ...........................................................^.^...^.^.^.^.^.......^...........................................................\n\
   .............................................................................................................................................\n\
   ..........................................................^.^...^.^.^.^.^.^.^.^...^..........................................................\n\
   .............................................................................................................................................\n\
   .........................................................^.^...^...^...^...^.....^.^.........................................................\n\
   .............................................................................................................................................\n\
   ........................................................^.^.^.^.^.^.^.^.^...^.^...^.^........................................................\n\
   .............................................................................................................................................\n\
   .......................................................^.^.^.^...^.^.^.^.^.^.^.^...^.^.......................................................\n\
   .............................................................................................................................................\n\
   ......................................................^.^.^.^...^.^.....^...^.^.^.^.^.^......................................................\n\
   .............................................................................................................................................\n\
   .....................................................^...^.^.^.^.^.^...^.^.^...^.^.^.^.^.....................................................\n\
   .............................................................................................................................................\n\
   ....................................................^.^.^.^.^.^.^...^.^.^...^.^.^.......^....................................................\n\
   .............................................................................................................................................\n\
   ...................................................^.^.^.^.^.^...^.^.^.^.^.^.^.^.^...^.^.^...................................................\n\
   .............................................................................................................................................\n\
   ..................................................^.^...^.^.^...^.^.....^.^.^...^...^.^.^.^..................................................\n\
   .............................................................................................................................................\n\
   .................................................^.^.^.^...^...........^.....^.^...^.^.^.^.^.................................................\n\
   .............................................................................................................................................\n\
   ................................................^.^.^...^.....^.^.^.^.^...^...^.^.^.^.^...^.^................................................\n\
   .............................................................................................................................................\n\
   ...............................................^...^.^.^.^.........^.^.^.^.^.^.^.^...^.^.^...^...............................................\n\
   .............................................................................................................................................\n\
   ..............................................^.^.^.^...^.....^...^.^.^.^.^.........^.^.^.^.^.^..............................................\n\
   .............................................................................................................................................\n\
   .............................................^.^...^.^...^.^.^.^.........^.^.^.^.^.^.^...^.^.^.^.............................................\n\
   .............................................................................................................................................\n\
   ............................................^.^.^.....^...^.......^...^.^.....^.^.^.^...^...^...^............................................\n\
   .............................................................................................................................................\n\
   ...........................................^...^.^...^.^.^.....^.^...^.......^.^...^.^.^.^.......^...........................................\n\
   .............................................................................................................................................\n\
   ..........................................^.^...^.^...^.^.^.^.^.^.^...^.^.^.^.^.^...^.^.^.^.^.^.^.^..........................................\n\
   .............................................................................................................................................\n\
   .........................................^.^.^.^.^.^.^.^.^.^...^...^.^...^.....^.....^.^.^.^.^.^.^.^.........................................\n\
   .............................................................................................................................................\n\
   ........................................^.^.^.....^.^.^.^.^...^.....^.^.^.^.^...^.^...^.......^.^...^........................................\n\
   .............................................................................................................................................\n\
   .......................................^.^.^.^.^.^.^.^...^.^.^.^.^.^.....^.^.^.^.^.^.^...^.^.^.^.^.^.^.......................................\n\
   .............................................................................................................................................\n\
   ......................................^...^.^.^.^.^.^.^...^.....^.^.^.^.^.^.^.^...^.^.^.....^.^.^.^...^......................................\n\
   .............................................................................................................................................\n\
   .....................................^.^.^...^.^.....^...^.^...^.^.^.^...^.^.^...^.^.......^...^...^.^.^.....................................\n\
   .............................................................................................................................................\n\
   ....................................^.^.....^.^.^.^.^.^.....^.....^.....^.^...^.^.......^.....^.^.^.^...^....................................\n\
   .............................................................................................................................................\n\
   ...................................^.^.^.^.^.^.^...^.^.....^.^.^.^...^...^.^.^.^.^.^...^...^...^...^.^...^...................................\n\
   .............................................................................................................................................\n\
   ..................................^.^.^.^...^.^.^.^.^...^.....^...^.^.^.^.^.^.^.^.^.^.....^.^.^.^...^.^.^.^..................................\n\
   .............................................................................................................................................\n\
   .................................^...^...^.^.^.^.^.^.^...^.^...^.^.....^.^.^.^.^.^.^.^.^.^.^.^.^.^...^...^.^.................................\n\
   .............................................................................................................................................\n\
   ................................^.^.^.^.^.....^.^...^.^.^.^.^.^.^.^...^...^.^.^.^.....^.^...^.^...^.....^.^.^................................\n\
   .............................................................................................................................................\n\
   ...............................^...^.....^.^.^.^...^.^.^.^.^.^.^.....^.......^...^...^.^.^...^...^.....^.^...^...............................\n\
   .............................................................................................................................................\n\
   ..............................^.^.^.^.^.^.^...^.^.^.^.^...^.^.....^...^.^...^.^.^.^.......^.^.^.^.^.^.^...^...^..............................\n\
   .............................................................................................................................................\n\
   .............................^.^...^...^.^...^.^.^...^.^.^.^...^...^.^.......^.^.^...^.^.^.^.^...^.^.^.^.^...^.^.............................\n\
   .............................................................................................................................................\n\
   ............................^.^.^.^.^.^.^.^.^...^...^.^.^.^.......^.^.^.^...^.^.^...^.^...^.^.^.^.^.^...^.^.^.^.^............................\n\
   .............................................................................................................................................\n\
   ...........................^...^.^.^.^.^.^.^.^.^.^.^...^.^.^...^.^.^.^.^.^.^.^.^.^.^...^.^...^.^.^...^.^.....^...^...........................\n\
   .............................................................................................................................................\n\
   ..........................^.^.^...^...^.^.^.^.^.^.....^.....^.^.^.^.^.....^.^.^.^.......^.^.^.^.^...^.^.^.^.^.....^..........................\n\
   .............................................................................................................................................\n\
   .........................^.^.^.^.^.^.^.^...^.^.^.^...^.^.^.^.^.^.....^.^.^...^...^...^.....^.....^.^.^...^.^...^...^.........................\n\
   .............................................................................................................................................\n\
   ........................^.....^...^.^...^.....^.^...^...^...^.....^...^.^...^.^.^.^.^.^.^...^.^.^.^.^...^.^.^.^.^...^........................\n\
   .............................................................................................................................................\n\
   .......................^.^.^.^.......^.^.^.^.^.^...^...^...^.^...^.^.^.^.^.^.^.^...^.^.^.....^.^...^.^.^.^.........^.^.......................\n\
   .............................................................................................................................................\n\
   ......................^.........^.^.....^.^...^.^.^.^.^.^.^.^...^.^.^...^...^.^...^.^...^.^.^.^.^.^.^...^.^.^.^...^.^.^......................\n\
   .............................................................................................................................................\n\
   .....................^.^...^.^...^...^.^.^.^.^...^.^.^.^.....^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.^.^.^.^.^.....................\n\
   .............................................................................................................................................\n\
   ....................^.^...^.^...^...^.^...^.^...^.^.^...^.^.^.^.......^.^.^.^.....^.^.^...^...^.^.^.^.^.^...^.^.^.^.^.^.^....................\n\
   .............................................................................................................................................\n\
   ...................^.^.^...^.^.....^...^.....^.^.^.^...^.^...^.....^.^.^.^.^.^.^.....^.^.^.......^.^.^.^.^.^.....^.^.^.^.^...................\n\
   .............................................................................................................................................\n\
   ..................^...^...^.^.^.....^.^.^.^.^.^.^.^.^.^.^.^.^.^...^...^.^.^.^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^...^...^...^..................\n\
   .............................................................................................................................................\n\
   .................^.^...^.^.^.^...^.^.^.^.^...^.^.^.^.^...^...^.^...^...^.^...^...^.^.....^.^.^.^.^.^.^.^.^.^...^.^...^.^...^.................\n\
   .............................................................................................................................................\n\
   ................^.^.^.^...^.^...^.^.^...^.^.^...^.^.^.^...^.....^.....^.^...^.^.^.^...^.^...^.^.^.....^...^.^.^.^...^...^.^.^................\n\
   .............................................................................................................................................\n\
   ...............^.^.....^.^.^.......^...^.^...^.^.^...^.^.^.^.^.^.^.^.^.^.^...^.^.....^.^.....^.^...^.^.^.^.^.^.^.^...^.^.^.^.^...............\n\
   .............................................................................................................................................\n\
   ..............^.^.^.....^.^...^.....^.^.....^...^.^.^.^.^...^.^.^.^.^.^.^.^.^.^...^.^...^.^.......^.^.^.^.^.^.^.^.^.....^.^.^.^..............\n\
   .............................................................................................................................................\n\
   .............^.^...^.^.^.^.....^...^.^.^.^.^.^.^.^.^.^.^.^...^.^...^.^.^.^.^...^.^.^.^.^.^.^.^.....^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.............\n\
   .............................................................................................................................................\n\
   ............^.....^.^...^.^.^.^.^.^.^.^...^.^.^.^.....^.^.^.^.^...^.^.^.^...^.^.^...........^...^.^...^.^.^.^.^.^.^...^.^.^.....^............\n\
   .............................................................................................................................................\n\
   ...........^...^.^...^.^.^.^.^.^.^.^.^.^.^.^.....^.....^.^.^.^.^...^.^...^.^.^...^...^...^.^.^.^.......^.....^.^.^.^...^...^.^.^.^...........\n\
   .............................................................................................................................................\n\
   ..........^.^.^.^.^.......^.^.^.^.^.^.^.^.^.^.^.^.^.^...^...^.^.^.^.^.^...^.^...^.^...^.^.....^.^.^.^...^.^.^.^.^.^.^.^.^.....^...^..........\n\
   .............................................................................................................................................\n\
   .........^.^.^.^...^.^.^...^.^.^.^...^.^...........^.^...^.^...^.^.^.....^.^.^.^.^...^.^...^.^.....^...^.^.^.^.^.^.^.^.^.^.^.^...^.^.........\n\
   .............................................................................................................................................\n\
   ........^.^.^...^.^.^.^...^.^.^...^.^.^...^...^.^...^...^...^.^.....^.^.....^.....^...^.^.^.^.^.^.....^.^.^.^.^.^.....^.^.^...^.^.^.^........\n\
   .............................................................................................................................................\n\
   .......^.^...^...^...^.^.....^.^.^.^...^.^.^.^.....^...^...^.^.^.^...^.^.^.^.^.^.^.^.^.^.^.^.^.....^.^...^...^.^.^.^.^.^.^.....^.....^.......\n\
   .............................................................................................................................................\n\
   ......^.^.^.....^.......^.^.^.^...^.^...^.^...^.........^.^.^.^.....^.^.^.....^.^...^...^...^.^...^...^...........^...^.^.....^.^.^...^......\n\
   .............................................................................................................................................\n\
   .....^.^.^.^.....^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^...........^.^...^.^...^.^...^...^.^.^...^.^...^.......^...^.^.^.^.^.^...^.^.^...^.....\n\
   .............................................................................................................................................\n\
   ....^.^...^...^.^.^.....^.^.^.^.^.^...^.......^.....^...^.^...^.^...^.....^.^.^.^.^.^.......^.^...^...^.^...^.^.^.^.^.^.^.^...^.^.^.^.^.^....\n\
   .............................................................................................................................................\n\
   ...^.^...^.^...^.^...^.^.^.^.^.^.........^.^.^...^...^...^.^.^...^.^.^.^.^.....^.^...^.........^...^.^.^...^.^...^.....^.......^.^.....^.^...\n\
   .............................................................................................................................................\n\
   ..^.^.^.^.^...^.^...^.^.^...^.^.^...^...^...^.^.^.^.^.^.^...^.^.^...^...^.^...^.^.^.^...^.......^.^.^.^...^.^.......^.^...^.^...^.^.^.^...^..\n\
   .............................................................................................................................................\n\
   .^.^.^.^...^...^...^...^.^.....^...^.^.^...^.^.^.^.^.^...^.^.^.^.........^.^.^.^...^.^...^...^.^.....^...^.^.^.^...^.^...^...^.^.^.^.^...^.^.\n\
   .............................................................................................................................................\n"

let rec process_line above current i split_counter =
  if i >= String.length current then ("", split_counter)
  else
    let above_char = above.[i] in
    let next_above_char =
      if i + 1 < String.length above then above.[i + 1] else ' '
    in
    let prev_above_char = if i > 0 then above.[i - 1] else ' ' in
    let current_char = current.[i] in
    let next_current_char =
      if i + 1 < String.length current then current.[i + 1] else ' '
    in
    let prev_current_char = if i > 0 then current.[i - 1] else ' ' in
    let new_char, counter =
      if
        next_current_char = '^' && next_above_char = '|'
        && (current_char = '|' || current_char = '.')
      then ('|', split_counter + 1)
      else if (above_char = 'S' || above_char = '|') && current_char = '.' then
        ('|', split_counter)
      else if
        next_current_char = '^' && next_above_char = '|'
        && (current_char = '|' || current_char = '.')
      then ('|', split_counter + 1)
      else if
        prev_current_char = '^' && prev_above_char = '|' && current_char = '.'
      then ('|', split_counter)
      else (current_char, split_counter)
    in
    let rest_line, final_counter = process_line above current (i + 1) counter in
    (String.make 1 new_char ^ rest_line, final_counter)

let rec process_lines prev lines split_counter =
  match lines with
  | [] ->
      ([], split_counter)
  | head :: tail ->
      let new_line, counter_after_line =
        match prev with
        | None ->
            (head, split_counter)
        | Some above ->
            process_line above head 0 split_counter
      in
      let rest_lines, final_counter =
        process_lines (Some new_line) tail counter_after_line
      in
      (new_line :: rest_lines, final_counter)

let () =
  let lines = String.split_on_char '\n' input in
  let result_lines, final_counter = process_lines None lines 0 in
  List.iter print_endline result_lines ;
  Printf.printf "\nCounter = %d\n" final_counter
